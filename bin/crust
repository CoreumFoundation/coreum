#!/bin/bash

set -e

# go to root dir of repository
pushd "$(dirname "${BASH_SOURCE[0]}")/.." > /dev/null
if [ ! -f ./bin/.cache/crust ]; then
  pushd build > /dev/null
  go build -trimpath -o ../bin/.cache/crust-tmp ./cmd
  popd > /dev/null

  ./bin/.cache/crust-tmp build/crust
  rm -f ./bin/.cache/crust-tmp
fi

REPO=$(pwd)
popd > /dev/null

case "$1" in

   "znet")
      if [ ! -f "$REPO/bin/.cache/znet" ]; then
        "$REPO/bin/.cache/crust" build/znet
      fi

      shift 1
      exec "$REPO/bin/.cache/znet" "$@"
      ;;

   "zstress")
     if [ ! -f "$REPO/bin/.cache/zstress" ]; then
       "$REPO/bin/.cache/crust" build/zstress
     fi

     shift 1
     exec "$REPO/bin/.cache/zstress" "$@"
     ;;

   *)
     exec "$REPO/bin/.cache/crust" "$@"
     ;;
esac
